(!is.na(`...5`) & `...5` != "Amount"))
View(test)
test <- df %>%
filter((!is.na(`...3`) & `...3` != "Object") & (!is.na(`...4`) & `...4` != "Subobject") &
(!is.na(`...5`) & `...5` != "Amount")) %>%
rename(`Service ID` = ID, `Object` = `...3`, `Subobject` = `...4`, `Amount` = `...5`, `BPFS Adjustment` = `Tollgate Recommendations`)
View(test)
files
agency = str_extract(file, "((?<=C:/Users/sara.brumfield2/OneDrive - City Of Baltimore/FY2024 Planning/03-TLS-BBMR Review/Agency Analysis Tools/FY24 Change Table ).+(?=.xlsx))")
data <- import("L:/BBMR_CSV_FILE_20230104.CSV")
violations <- data %>%
mutate_at(vars(ends_with("DATE")), ymd) %>%
mutate(Fees = case_when(`VIOL CODE` %in% c(30, 31) ~ 75,
`VIOL CODE` %in% c(32, 33, 34, 35) ~ 40,
`VIOL CODE` == 36 ~ 0,
`VIOL CODE` == 37 ~ 125,
`VIOL CODE` == 38 ~ 250),
Type = case_when(`VIOL CODE` == 30 ~ "Red Light Violation",
`VIOL CODE` == 31 ~ "Right on Red",
`VIOL CODE` == 32 ~ "Speed Violation",
`VIOL CODE` == 33 ~ "No Description",
`VIOL CODE` == 34 ~ "No Description",
`VIOL CODE` == 35 ~ "No Description",
`VIOL CODE` == 36 ~ "No Description",
`VIOL CODE` == 37 ~ "No Description",
`VIOL CODE` == 38 ~ "No Description"),
`VIOL MONTH` = ymd(paste0(year(`VIOL DATE`), "-", month(`VIOL DATE`), "-01"))) %>%
mutate(Status = case_when(STATUS == "P" ~ "Paid in full",
STATUS == "O" ~ "Open",
(STATUS == "A" & is.na(`PAID DATE`)) ~ "Balance abated (unpaid)",
(STATUS == "A" & !is.na(`PAID DATE`)) ~ "Balance abated (paid)",
STATUS == "H" ~ "Hold processing",
STATUS == "U" ~ "Uncollectable",
TRUE ~ STATUS),
`Year` = format(`VIOL DATE`, format = "%Y"))
violations <- violations %>% mutate(`Year` = format(`VIOL DATE`, format = "%Y"),
`Month` = format(`VIOL DATE`, format = "%m"),
`Year-Month` = format(`VIOL DATE`, format = "%Y-%m"))
issued <- violations %>%
select(`Year-Month`, `CITATION`, `Type`, LOCATION) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = CITATION, values_fn = list(CITATION = length))
paid <- violations %>%
filter(Status %in% c("Paid in full", "Balance abated (paid)")) %>%
select(`Year-Month`, `CITATION`, `Type`, Status, LOCATION) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = CITATION, values_fn = list(CITATION = length))
status_count <- violations %>%
select(`Year-Month`, `CITATION`, `Type`) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = CITATION, values_fn = list(CITATION = length))
View(status_count)
status_count <- violations %>%
select(`Year-Month`, `CITATION`, `Type`, Status) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = CITATION, values_fn = list(CITATION = length))
View(status_count)
library(janitor)
status_fees <- violations %>%
select(`Year-Month`, Fees, `Type`, Status) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = Fees, values_fn = sum) %>%
arrange(Type, Status)
View(status_fees)
violations <- data %>%
mutate_at(vars(ends_with("DATE")), ymd) %>%
##filter out data from previous FYs starting Feb 2023
mutate(Fees = case_when(`VIOL CODE` %in% c(30, 31) ~ 75,
`VIOL CODE` %in% c(32, 33, 34, 35) ~ 40,
`VIOL CODE` == 36 ~ 0,
`VIOL CODE` == 37 ~ 125,
`VIOL CODE` == 38 ~ 250),
Type = case_when(`VIOL CODE` == 30 ~ "Red Light Violation",
`VIOL CODE` == 31 ~ "Right on Red",
`VIOL CODE` == 32 ~ "Speed Violation",
`VIOL CODE` == 33 ~ "No Description",
`VIOL CODE` == 34 ~ "No Description",
`VIOL CODE` == 35 ~ "No Description",
`VIOL CODE` == 36 ~ "No Description",
`VIOL CODE` == 37 ~ "No Description",
`VIOL CODE` == 38 ~ "No Description",
is.na(`VIOL CODE`) ~ "Unknown",
TRUE ~ `VIOL CODE`),
`VIOL MONTH` = ymd(paste0(year(`VIOL DATE`), "-", month(`VIOL DATE`), "-01"))) %>%
mutate(Status = case_when(STATUS == "P" ~ "Paid in full",
STATUS == "O" ~ "Open",
(STATUS == "A" & is.na(`PAID DATE`)) ~ "Balance abated (unpaid)",
(STATUS == "A" & !is.na(`PAID DATE`)) ~ "Balance abated (paid)",
STATUS == "H" ~ "Hold processing",
STATUS == "U" ~ "Uncollectable",
TRUE ~ STATUS),
`Year` = format(`VIOL DATE`, format = "%Y"))
violations <- data %>%
mutate_at(vars(ends_with("DATE")), ymd) %>%
##filter out data from previous FYs starting Feb 2023
mutate(Fees = case_when(`VIOL CODE` %in% c(30, 31) ~ 75,
`VIOL CODE` %in% c(32, 33, 34, 35) ~ 40,
`VIOL CODE` == 36 ~ 0,
`VIOL CODE` == 37 ~ 125,
`VIOL CODE` == 38 ~ 250),
Type = case_when(`VIOL CODE` == 30 ~ "Red Light Violation",
`VIOL CODE` == 31 ~ "Right on Red",
`VIOL CODE` == 32 ~ "Speed Violation",
`VIOL CODE` == 33 ~ "No Description",
`VIOL CODE` == 34 ~ "No Description",
`VIOL CODE` == 35 ~ "No Description",
`VIOL CODE` == 36 ~ "No Description",
`VIOL CODE` == 37 ~ "No Description",
`VIOL CODE` == 38 ~ "No Description",
is.na(`VIOL CODE`) ~ "Unknown",
TRUE ~ `VIOL CODE`),
`VIOL MONTH` = ymd(paste0(year(`VIOL DATE`), "-", month(`VIOL DATE`), "-01")),
Status = case_when(STATUS == "P" ~ "Paid in full",
STATUS == "O" ~ "Open",
(STATUS == "A" & is.na(`PAID DATE`)) ~ "Balance abated (unpaid)",
(STATUS == "A" & !is.na(`PAID DATE`)) ~ "Balance abated (paid)",
STATUS == "H" ~ "Hold processing",
STATUS == "U" ~ "Uncollectable",
TRUE ~ STATUS),
`Year` = format(`VIOL DATE`, format = "%Y"))
rlang::last_error()
rlang::last_trace()
violations <- data %>%
mutate_at(vars(ends_with("DATE")), ymd) %>%
##filter out data from previous FYs starting Feb 2023
mutate(Fees = case_when(`VIOL CODE` %in% c(30, 31) ~ 75,
`VIOL CODE` %in% c(32, 33, 34, 35) ~ 40,
`VIOL CODE` == 36 ~ 0,
`VIOL CODE` == 37 ~ 125,
`VIOL CODE` == 38 ~ 250),
Type = case_when(`VIOL CODE` == 30 ~ "Red Light Violation",
`VIOL CODE` == 31 ~ "Right on Red",
`VIOL CODE` == 32 ~ "Speed Violation",
`VIOL CODE` == 33 ~ "No Description",
`VIOL CODE` == 34 ~ "No Description",
`VIOL CODE` == 35 ~ "No Description",
`VIOL CODE` == 36 ~ "No Description",
`VIOL CODE` == 37 ~ "No Description",
`VIOL CODE` == 38 ~ "No Description",
is.na(`VIOL CODE`) ~ "Unknown"),
`VIOL MONTH` = ymd(paste0(year(`VIOL DATE`), "-", month(`VIOL DATE`), "-01")),
Status = case_when(STATUS == "P" ~ "Paid in full",
STATUS == "O" ~ "Open",
(STATUS == "A" & is.na(`PAID DATE`)) ~ "Balance abated (unpaid)",
(STATUS == "A" & !is.na(`PAID DATE`)) ~ "Balance abated (paid)",
STATUS == "H" ~ "Hold processing",
STATUS == "U" ~ "Uncollectable",
TRUE ~ STATUS),
`Year` = format(`VIOL DATE`, format = "%Y"))
unique(violations$Type)
violations <- data %>%
mutate_at(vars(ends_with("DATE")), ymd) %>%
##filter out data from previous FYs starting Feb 2023
mutate(Fees = case_when(`VIOL CODE` %in% c(30, 31) ~ 75,
`VIOL CODE` %in% c(32, 33, 34, 35) ~ 40,
`VIOL CODE` == 36 ~ 0,
`VIOL CODE` == 37 ~ 125,
`VIOL CODE` == 38 ~ 250),
Type = case_when(`VIOL CODE` == 30 ~ "Red Light Violation",
`VIOL CODE` == 31 ~ "Right on Red",
`VIOL CODE` == 32 ~ "Speed Violation",
`VIOL CODE` == 33 ~ "No Description",
`VIOL CODE` == 34 ~ "No Description",
`VIOL CODE` == 35 ~ "No Description",
`VIOL CODE` == 36 ~ "No Description",
`VIOL CODE` == 37 ~ "No Description",
`VIOL CODE` == 38 ~ "No Description",
`VIOL CODE` == NA ~ "Unknown"),
`VIOL MONTH` = ymd(paste0(year(`VIOL DATE`), "-", month(`VIOL DATE`), "-01")),
Status = case_when(STATUS == "P" ~ "Paid in full",
STATUS == "O" ~ "Open",
(STATUS == "A" & is.na(`PAID DATE`)) ~ "Balance abated (unpaid)",
(STATUS == "A" & !is.na(`PAID DATE`)) ~ "Balance abated (paid)",
STATUS == "H" ~ "Hold processing",
STATUS == "U" ~ "Uncollectable",
TRUE ~ STATUS),
`Year` = format(`VIOL DATE`, format = "%Y"))
unique(violations$Type)
unique(violations$`VIOL CODE`)
violations %>% filter(`VIOL CODE` == 2)
violations %>% filter(`VIOL CODE` == 3)
violations %>% filter(`VIOL CODE` == 99)
unique(violations$STATUS)
violations <- data %>%
mutate_at(vars(ends_with("DATE")), ymd) %>%
##filter out data from previous FYs starting Feb 2023
mutate(Fees = case_when(`VIOL CODE` %in% c(30, 31) ~ 75,
`VIOL CODE` %in% c(32, 33, 34, 35) ~ 40,
`VIOL CODE` == 36 ~ 0,
`VIOL CODE` == 37 ~ 125,
`VIOL CODE` == 38 ~ 250
`VIOL CODE` == 99 ~ 32,
violations <- data %>%
mutate_at(vars(ends_with("DATE")), ymd) %>%
##filter out data from previous FYs starting Feb 2023
mutate(Fees = case_when(`VIOL CODE` %in% c(30, 31) ~ 75,
`VIOL CODE` %in% c(32, 33, 34, 35) ~ 40,
`VIOL CODE` == 36 ~ 0,
`VIOL CODE` == 37 ~ 125,
`VIOL CODE` == 38 ~ 250,
`VIOL CODE` == 99 ~ 32,
`VIOL CODE` %in% c(2, 3) ~ 102),
Type = case_when(`VIOL CODE` == 30 ~ "Red Light Violation",
`VIOL CODE` == 31 ~ "Right on Red",
`VIOL CODE` == 32 ~ "Speed Violation",
`VIOL CODE` == 33 ~ "No Description",
`VIOL CODE` == 34 ~ "No Description",
`VIOL CODE` == 35 ~ "No Description",
`VIOL CODE` == 36 ~ "No Description",
`VIOL CODE` == 37 ~ "No Description",
`VIOL CODE` == 38 ~ "No Description",
`VIOL CODE` == 2 ~ "No Stopping or No Parking Pimlico Event",
`VIOL CODE` == 3 ~ "Obstruct/Impeding Flow of Traffic",
`VIOL CODE` == 99 ~ "All Other Stopping or Parking Violations",
`VIOL CODE` == NA ~ "Unknown"),
`VIOL MONTH` = ymd(paste0(year(`VIOL DATE`), "-", month(`VIOL DATE`), "-01")),
Status = case_when(STATUS == "P" ~ "Paid in full",
STATUS == "O" ~ "Open",
(STATUS == "A" & is.na(`PAID DATE`)) ~ "Balance abated (unpaid)",
(STATUS == "A" & !is.na(`PAID DATE`)) ~ "Balance abated (paid)",
STATUS == "H" ~ "Hold processing",
STATUS == "U" ~ "Uncollectable",
TRUE ~ STATUS),
`Year` = format(`VIOL DATE`, format = "%Y"))
violations <- violations %>% mutate(`Year` = format(`VIOL DATE`, format = "%Y"),
`Month` = format(`VIOL DATE`, format = "%m"),
`Year-Month` = format(`VIOL DATE`, format = "%Y-%m"))
issued <- violations %>%
select(`Year-Month`, `CITATION`, `Type`, LOCATION) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = CITATION, values_fn = list(CITATION = length))
paid <- violations %>%
filter(Status %in% c("Paid in full", "Balance abated (paid)")) %>%
select(`Year-Month`, `CITATION`, `Type`, Status, LOCATION) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = CITATION, values_fn = list(CITATION = length))
status_count <- violations %>%
select(`Year-Month`, `CITATION`, `Type`, Status) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = CITATION, values_fn = list(CITATION = length)) %>%
arrange(Type, Status)
status_fees <- violations %>%
select(`Year-Month`, Fees, `Type`, Status) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = Fees, values_fn = sum) %>%
arrange(Type, Status)
View(status_count)
View(status_fees)
?remove_empty
status_count <- violations %>%
select(`Year-Month`, `CITATION`, `Type`, Status) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = CITATION, values_fn = list(CITATION = length)) %>%
arrange(Type, Status) %>%
remove_empty(which = "rows", quiet = FALSE)
status_fees <- violations %>%
select(`Year-Month`, Fees, `Type`, Status) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = Fees, values_fn = sum) %>%
arrange(Type, Status) %>%
remove_empty(which = "rows", quiet = FALSE)
View(status_count)
export_excel(issued, "Issued", paste0("outputs/Camera Violations ", Sys.Date() ,".xlsx"), "new")
export_excel(paid, "Paid", paste0("outputs/Camera Violations ", Sys.Date(), ".xlsx"), "existing")
export_excel(status_count, "Status", paste0("outputs/Camera Violations ", Sys.Date(), ".xlsx"), "existing")
.libPaths("C:/Users/sara.brumfield2/OneDrive - City Of Baltimore/Documents/r_library")
library(tidyverse)
library(lubridate)
library(rio)
library(janitor)
devtools::load_all("G:/Analyst Folders/Sara Brumfield/_packages/bbmR")
data <- import("L:/BBMR_CSV_FILE_20230202.CSV")
colnames(data)
head(data)
violations <- data %>%
mutate_at(vars(ends_with("DATE")), ymd) %>%
##filter out data from previous FYs starting Feb 2023
filter(`VIOL DATE` >= "2022-07-01")
View(violations)
violations <- data %>%
mutate_at(vars(ends_with("DATE")), ymd) %>%
##filter out data from previous FYs starting Feb 2023
filter(`VIOL DATE` >= "2022-07-01") %>%
mutate(Fees = case_when(`VIOL CODE` %in% c(30, 31) ~ 75,
`VIOL CODE` %in% c(32, 33, 34, 35) ~ 40,
`VIOL CODE` == 36 ~ 0,
`VIOL CODE` == 37 ~ 125,
`VIOL CODE` == 38 ~ 250,
`VIOL CODE` == 99 ~ 32,
`VIOL CODE` %in% c(2, 3) ~ 102),
Type = case_when(`VIOL CODE` == 30 ~ "Red Light Violation",
`VIOL CODE` == 31 ~ "Right on Red",
`VIOL CODE` == 32 ~ "Speed Violation",
`VIOL CODE` == 33 ~ "No Description",
`VIOL CODE` == 34 ~ "No Description",
`VIOL CODE` == 35 ~ "No Description",
`VIOL CODE` == 36 ~ "No Description",
`VIOL CODE` == 37 ~ "No Description",
`VIOL CODE` == 38 ~ "No Description",
`VIOL CODE` == 2 ~ "No Stopping or No Parking Pimlico Event",
`VIOL CODE` == 3 ~ "Obstruct/Impeding Flow of Traffic",
`VIOL CODE` == 99 ~ "All Other Stopping or Parking Violations",
`VIOL CODE` == NA ~ "Unknown"),
`VIOL MONTH` = ymd(paste0(year(`VIOL DATE`), "-", month(`VIOL DATE`), "-01")),
Status = case_when(STATUS == "P" ~ "Paid in full",
STATUS == "O" ~ "Open",
(STATUS == "A" & is.na(`PAID DATE`)) ~ "Balance abated (unpaid)",
(STATUS == "A" & !is.na(`PAID DATE`)) ~ "Balance abated (paid)",
STATUS == "H" ~ "Hold processing",
STATUS == "U" ~ "Uncollectable",
TRUE ~ STATUS),
`Year` = format(`VIOL DATE`, format = "%Y"))
View(violations)
violations <- violations %>% mutate(`Year` = format(`VIOL DATE`, format = "%Y"),
`Month` = format(`VIOL DATE`, format = "%m"),
`Year-Month` = format(`VIOL DATE`, format = "%Y-%m"))
issued <- violations %>%
select(`Year-Month`, `CITATION`, `Type`, LOCATION) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = CITATION, values_fn = list(CITATION = length))
paid <- violations %>%
filter(Status %in% c("Paid in full", "Balance abated (paid)")) %>%
select(`Year-Month`, `CITATION`, `Type`, Status, LOCATION) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = CITATION, values_fn = list(CITATION = length))
status_count <- violations %>%
select(`Year-Month`, `CITATION`, `Type`, Status) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = CITATION, values_fn = list(CITATION = length)) %>%
arrange(Type, Status) %>%
remove_empty(which = "rows", quiet = FALSE)
status_fees <- violations %>%
select(`Year-Month`, Fees, `Type`, Status) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = Fees, values_fn = sum) %>%
arrange(Type, Status) %>%
remove_empty(which = "rows", quiet = FALSE)
export_excel(issued, "Issued", paste0("outputs/Camera Violations ", Sys.Date() ,".xlsx"), "new")
export_excel(paid, "Paid", paste0("outputs/Camera Violations ", Sys.Date(), ".xlsx"), "existing")
export_excel(status_count, "Status Count", paste0("outputs/Camera Violations ", Sys.Date(), ".xlsx"), "existing")
export_excel(status_fees, "Status Fees", paste0("outputs/Camera Violations ", Sys.Date(), ".xlsx"), "existing")
violations <- data %>%
mutate_at(vars(ends_with("DATE")), ymd) %>%
##filter out data from previous FYs starting Feb 2023
filter(`VIOL DATE` >= "2022-07-01") %>%
mutate(Fees = case_when(`VIOL CODE` %in% c(30, 31) ~ 75,
`VIOL CODE` %in% c(32, 33, 34, 35) ~ 40,
`VIOL CODE` == 36 ~ 0,
`VIOL CODE` == 37 ~ 125,
`VIOL CODE` == 38 ~ 250,
`VIOL CODE` == 99 ~ 32,
`VIOL CODE` %in% c(2, 3) ~ 102),
Type = case_when(`VIOL CODE` == 30 ~ "Red Light Violation",
`VIOL CODE` == 31 ~ "Right on Red",
`VIOL CODE` == 32 ~ "Speed Violation",
`VIOL CODE` == 33 ~ "No Description",
`VIOL CODE` == 34 ~ "No Description",
`VIOL CODE` == 35 ~ "No Description",
`VIOL CODE` == 36 ~ "No Description",
`VIOL CODE` == 37 ~ "No Description",
`VIOL CODE` == 38 ~ "No Description",
`VIOL CODE` == 2 ~ "No Stopping or No Parking Pimlico Event",
`VIOL CODE` == 3 ~ "Obstruct/Impeding Flow of Traffic",
`VIOL CODE` == 99 ~ "All Other Stopping or Parking Violations",
`VIOL CODE` == NA ~ "Unknown",
TRUE ~ `VIOL CODE`),
`VIOL MONTH` = ymd(paste0(year(`VIOL DATE`), "-", month(`VIOL DATE`), "-01")),
Status = case_when(STATUS == "P" ~ "Paid in full",
STATUS == "O" ~ "Open",
(STATUS == "A" & is.na(`PAID DATE`)) ~ "Balance abated (unpaid)",
(STATUS == "A" & !is.na(`PAID DATE`)) ~ "Balance abated (paid)",
STATUS == "H" ~ "Hold processing",
STATUS == "U" ~ "Uncollectable",
TRUE ~ STATUS),
`Year` = format(`VIOL DATE`, format = "%Y"))
View(violations)
unique(violations$`VIOL CODE`)
data %>% filter(`VIOL CODE` == 39)
violations <- data %>%
mutate_at(vars(ends_with("DATE")), ymd) %>%
##filter out data from previous FYs starting Feb 2023
filter(`VIOL DATE` >= "2022-07-01") %>%
mutate(Fees = case_when(`VIOL CODE` %in% c(30, 31) ~ 75,
`VIOL CODE` %in% c(32, 33, 34, 35) ~ 40,
`VIOL CODE` == 36 ~ 0,
`VIOL CODE` == 37 ~ 125,
`VIOL CODE` == 38 ~ 250,
`VIOL CODE` == 99 ~ 32,
`VIOL CODE` %in% c(2, 3) ~ 102),
Type = case_when(`VIOL CODE` == 30 ~ "Red Light Violation",
`VIOL CODE` == 31 ~ "Right on Red",
`VIOL CODE` == 32 ~ "Speed Violation",
`VIOL CODE` == 33 ~ "No Description",
`VIOL CODE` == 34 ~ "No Description",
`VIOL CODE` == 35 ~ "No Description",
`VIOL CODE` == 36 ~ "No Description",
`VIOL CODE` == 37 ~ "No Description",
`VIOL CODE` == 38 ~ "No Description",
`VIOL CODE` == 39 ~ "Interstate 83",
`VIOL CODE` == 2 ~ "No Stopping or No Parking Pimlico Event",
`VIOL CODE` == 3 ~ "Obstruct/Impeding Flow of Traffic",
`VIOL CODE` == 99 ~ "All Other Stopping or Parking Violations",
`VIOL CODE` == NA ~ "Unknown"),
`VIOL MONTH` = ymd(paste0(year(`VIOL DATE`), "-", month(`VIOL DATE`), "-01")),
Status = case_when(STATUS == "P" ~ "Paid in full",
STATUS == "O" ~ "Open",
(STATUS == "A" & is.na(`PAID DATE`)) ~ "Balance abated (unpaid)",
(STATUS == "A" & !is.na(`PAID DATE`)) ~ "Balance abated (paid)",
STATUS == "H" ~ "Hold processing",
STATUS == "U" ~ "Uncollectable",
TRUE ~ STATUS),
`Year` = format(`VIOL DATE`, format = "%Y"))
violations <- violations %>% mutate(`Year` = format(`VIOL DATE`, format = "%Y"),
`Month` = format(`VIOL DATE`, format = "%m"),
`Year-Month` = format(`VIOL DATE`, format = "%Y-%m"))
issued <- violations %>%
select(`Year-Month`, `CITATION`, `Type`, LOCATION) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = CITATION, values_fn = list(CITATION = length))
paid <- violations %>%
filter(Status %in% c("Paid in full", "Balance abated (paid)")) %>%
select(`Year-Month`, `CITATION`, `Type`, Status, LOCATION) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = CITATION, values_fn = list(CITATION = length))
status_count <- violations %>%
select(`Year-Month`, `CITATION`, `Type`, Status) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = CITATION, values_fn = list(CITATION = length)) %>%
arrange(Type, Status) %>%
remove_empty(which = "rows", quiet = FALSE)
status_fees <- violations %>%
select(`Year-Month`, Fees, `Type`, Status) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = Fees, values_fn = sum) %>%
arrange(Type, Status) %>%
remove_empty(which = "rows", quiet = FALSE)
export_excel(issued, "Issued", paste0("outputs/Camera Violations ", Sys.Date() ,".xlsx"), "new")
export_excel(paid, "Paid", paste0("outputs/Camera Violations ", Sys.Date(), ".xlsx"), "existing")
export_excel(status_count, "Status Count", paste0("outputs/Camera Violations ", Sys.Date(), ".xlsx"), "existing")
export_excel(status_fees, "Status Fees", paste0("outputs/Camera Violations ", Sys.Date(), ".xlsx"), "existing")
violations %>% filter(`VIOL CODE` == 33)
violations %>% filter(`VIOL CODE` == 34)
violations %>% filter(`VIOL CODE` == 35)
violations %>% filter(`VIOL CODE` == 36)
violations %>% filter(`VIOL CODE` == 37)
violations %>% filter(`VIOL CODE` == 38)
data %>% filter(`VIOL CODE` == 33)
data %>% filter(`VIOL CODE` == 34)
data %>% filter(`VIOL CODE` == 35)
violations <- data %>%
mutate_at(vars(ends_with("DATE")), ymd) %>%
##filter out data from previous FYs starting Feb 2023
filter(`VIOL DATE` >= "2022-07-01") %>%
mutate(Fees = case_when(`VIOL CODE` %in% c(30, 31) ~ 75,
`VIOL CODE` %in% c(32, 33, 34, 35) ~ 40,
`VIOL CODE` == 36 ~ 0,
`VIOL CODE` == 37 ~ 125,
`VIOL CODE` == 38 ~ 250,
`VIOL CODE` == 99 ~ 32,
`VIOL CODE` %in% c(2, 3) ~ 102),
Type = case_when(`VIOL CODE` == 30 ~ "Red Light Violation",
`VIOL CODE` == 31 ~ "Right on Red",
`VIOL CODE` == 32 ~ "Speed Violation",
`VIOL CODE` == 33 ~ "No Description",
`VIOL CODE` == 34 ~ "No Description",
`VIOL CODE` == 35 ~ "No Description",
`VIOL CODE` == 36 ~ "Truck Overheight Warning Notice",
`VIOL CODE` == 37 ~ "Truck Overheight Second Violation",
`VIOL CODE` == 38 ~ "Truck Overheight Third or Subsequent Violation",
`VIOL CODE` == 39 ~ "Interstate 83",
`VIOL CODE` == 2 ~ "No Stopping or No Parking Pimlico Event",
`VIOL CODE` == 3 ~ "Obstruct/Impeding Flow of Traffic",
`VIOL CODE` == 99 ~ "All Other Stopping or Parking Violations",
`VIOL CODE` == NA ~ "Unknown"),
`VIOL MONTH` = ymd(paste0(year(`VIOL DATE`), "-", month(`VIOL DATE`), "-01")),
Status = case_when(STATUS == "P" ~ "Paid in full",
STATUS == "O" ~ "Open",
(STATUS == "A" & is.na(`PAID DATE`)) ~ "Balance abated (unpaid)",
(STATUS == "A" & !is.na(`PAID DATE`)) ~ "Balance abated (paid)",
STATUS == "H" ~ "Hold processing",
STATUS == "U" ~ "Uncollectable",
TRUE ~ STATUS),
`Year` = format(`VIOL DATE`, format = "%Y"))
#this can take a while
violations <- violations %>% mutate(`Year` = format(`VIOL DATE`, format = "%Y"),
`Month` = format(`VIOL DATE`, format = "%m"),
`Year-Month` = format(`VIOL DATE`, format = "%Y-%m"))
issued <- violations %>%
select(`Year-Month`, `CITATION`, `Type`, LOCATION) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = CITATION, values_fn = list(CITATION = length))
paid <- violations %>%
filter(Status %in% c("Paid in full", "Balance abated (paid)")) %>%
select(`Year-Month`, `CITATION`, `Type`, Status, LOCATION) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = CITATION, values_fn = list(CITATION = length))
status_count <- violations %>%
select(`Year-Month`, `CITATION`, `Type`, Status) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = CITATION, values_fn = list(CITATION = length)) %>%
arrange(Type, Status) %>%
remove_empty(which = "rows", quiet = FALSE)
status_fees <- violations %>%
select(`Year-Month`, Fees, `Type`, Status) %>%
arrange(`Year-Month`) %>%
pivot_wider(names_from = `Year-Month`, values_from = Fees, values_fn = sum) %>%
arrange(Type, Status) %>%
remove_empty(which = "rows", quiet = FALSE)
export_excel(issued, "Issued", paste0("outputs/Camera Violations ", Sys.Date() ,".xlsx"), "new")
export_excel(paid, "Paid", paste0("outputs/Camera Violations ", Sys.Date(), ".xlsx"), "existing")
export_excel(status_count, "Status Count", paste0("outputs/Camera Violations ", Sys.Date(), ".xlsx"), "existing")
export_excel(status_fees, "Status Fees", paste0("outputs/Camera Violations ", Sys.Date(), ".xlsx"), "existing")
